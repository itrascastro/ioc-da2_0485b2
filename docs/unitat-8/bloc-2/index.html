---
layout: bloc
title: "Bloc 2: Gestió i manteniment de dades"
description: "Tutorial complet: configuració de l'entorn, implementació d'Hibernate i verificació amb PostgreSQL"
keywords: "Hibernate, PostgreSQL, Java, Maven, Visual Studio Code, Tutorial"
unitat: 8
bloc: 2
bloc_numero: 2
---

<!--
  Bloc 2 (Unitat 8) - Transcripció i enriquiment del tutorial validat
  Font principal: tutorial-hibernate-postgresql-vscode.pdf (42 pàgines)
  Objectiu: l'alumne pot seguir el pas a pas sense recursos addicionals.
-->

<div class="section">
    <h2 id="Unitat8_Bloc2_Seccio1">Preparació de l'entorn de treball</h2>

    {% include objectius.html llista="Comprendre l'abast del projecte i les habilitats que s'adquiriran|Instal·lar totes les eines necessàries (Java 21, PostgreSQL 16, Visual Studio Code, Maven)|Validar la configuració de l'entorn abans de continuar" %}

    <h3>Què aprendràs en aquest bloc</h3>
    <p>Treballaràs amb una aplicació Java moderna que utilitza Hibernate 6 per connectar-se a PostgreSQL. Aprendràs a configurar un <em>toolchain</em> complet: instal·lació de dependències, configuració de Visual Studio Code, creació d'un projecte Maven, implementació de classes i execució de proves.</p>

    <h3>Software necessari</h3>
    <ul>
        <li>Java JDK 21 (Temurin o equivalent).</li>
        <li>PostgreSQL 16 (amb eines <code>psql</code> o pgAdmin).</li>
        <li>Visual Studio Code (última versió estable).</li>
        <li>Extensions de VS Code per a Java i Maven.</li>
        <li>Apache Maven (normalment inclòs a l'Extension Pack for Java).</li>
    </ul>

    {% include info_box.html contingut="El tutorial es basa en Java 21 i PostgreSQL 16. Versions inferiors poden provocar incompatibilitats amb Hibernate 6." %}

    <h3>Instal·lació del JDK 21</h3>
    <p>Segueix les instruccions específiques per al teu sistema operatiu. Després de cada instal·lació, comprova la versió amb <code>java -version</code>.</p>

    <h4>Windows</h4>
    <ol>
        <li>Visita <a href="https://adoptium.net" target="_blank" rel="noopener">adoptium.net</a> i descarrega <strong>Temurin JDK 21</strong> per a Windows.</li>
        <li>Executa l'instal·lador i deixa les opcions per defecte.</li>
        <li>Marca l'opció «Establir les variables d'entorn JAVA_HOME».</li>
        <li>Finalitza l'assistent i obre el <em>Símbol del sistema</em>.</li>
        <li>Escriu <code>java -version</code>; hauries de veure una sortida similar a:<br><code>openjdk version "21.0.2" 2024-01-16</code></li>
    </ol>

    <h4>macOS</h4>
    <ol>
        <li>Obre Terminal.</li>
        <li>Si utilitzes Homebrew: <code>brew tap homebrew/cask-versions</code> i després <code>brew install --cask temurin21</code>.</li>
        <li>Sense Homebrew, descarrega l'instal·lador des d'<a href="https://adoptium.net" target="_blank" rel="noopener">adoptium.net</a> i segueix l'assistent.</li>
        <li>Verifica la instal·lació amb <code>java -version</code>.</li>
    </ol>

    <h4>Linux (Ubuntu/Debian)</h4>
    <ol>
        <li>Obre Terminal i executa:<br><code>sudo apt update</code><br><code>sudo apt install openjdk-21-jdk</code></li>
        <li>Si el repositori no disposa de la versió 21, afegeix un PPA oficial (vegeu tutorial).</li>
        <li>Verifica amb <code>java -version</code>.</li>
    </ol>

    {% include checklist.html titol="Checklist inicial" elements="JAVA_HOME apunta al directori del JDK 21|La comanda java -version retorna la versió correcta|El PATH inclou les eines del JDK" %}

    {% include prompt-ai.html contingut="Comprova que JAVA_HOME i java -version retornen la configuració esperada al meu sistema (Windows/Mac/Linux). Dona'm un script que pugui executar directament." %}

    {% include warning_box.html contingut="No avancis cap als passos de PostgreSQL fins a tenir el JDK configurat i verificat; Hibernate necessita el JDK per arrencar." %}
</div>

<div class="section">
    <h2 id="Unitat8_Bloc2_Seccio2">Configuració de la base de dades PostgreSQL</h2>

    <p>PostgreSQL serà el servei de bases de dades on Hibernate realitzarà les operacions CRUD. Segueix la guia per instal·lar-lo, ajustar l'autenticació i crear els recursos necessaris.</p>

    <h3>Instal·lació de PostgreSQL 16</h3>

    <h4>Windows</h4>
    <ol>
        <li>Visita <a href="https://www.postgresql.org/download/windows/" target="_blank" rel="noopener">postgresql.org</a> i descarrega l'instal·lador de PostgreSQL 16.</li>
        <li>Executa l'assistent, seleccionant tots els components (pgAdmin, línia d'ordres, Stack Builder opcional).</li>
        <li>Defineix una contrasenya per a l'usuari administrador <code>postgres</code> i recorda-la.</li>
        <li>Deixa el port per defecte (5432) i completa la instal·lació.</li>
        <li>Verifica l'accés obrint pgAdmin 4 o executant <code>psql -U postgres</code>.</li>
    </ol>

    <h4>macOS</h4>
    <ol>
        <li>Amb Homebrew: <code>brew install postgresql@16</code>.</li>
        <li>Inicia el servei: <code>brew services start postgresql@16</code>.</li>
        <li>Alternativament, utilitza l'instal·lador oficial de la web.</li>
        <li>Comprova la versió amb <code>psql --version</code>.</li>
    </ol>

    <h4>Linux (Ubuntu/Debian)</h4>
    <ol>
        <li>Afegeix el repositori oficial si cal i instal·la:<br><code>sudo apt update</code><br><code>sudo apt install postgresql-16 postgresql-contrib-16</code></li>
        <li>Inicia el servei: <code>sudo systemctl start postgresql</code></li>
        <li>Activa l'arrencada automàtica: <code>sudo systemctl enable postgresql</code></li>
        <li>Verifica l'estat: <code>sudo systemctl status postgresql</code></li>
    </ol>

    <h3>Autenticació en Linux (error «Peer authentication failed»)</h3>
    <ol>
        <li>Localitza <code>pg_hba.conf</code>:<br><code>sudo find /etc/postgresql -name "pg_hba.conf"</code></li>
        <li>Edita'l (substitueix <code>X.X</code> per la teva versió):<br><code>sudo nano /etc/postgresql/X.X/main/pg_hba.conf</code></li>
        <li>Canvia els mètodes <code>peer</code>/<code>scram-sha-256</code> per <code>md5</code> en connexions locals:</li>
    </ol>

    {% capture code_pghba %}
# TYPE  DATABASE        USER            ADDRESS             METHOD
local   all             all                                 md5
host    all             all             127.0.0.1/32        md5
host    all             all             ::1/128             md5
    {% endcapture %}
    {% include code-block.html lang="text" code=code_pghba %}

    <ol start="4">
        <li>Desa els canvis i reinicia PostgreSQL:<br><code>sudo systemctl restart postgresql</code></li>
        <li>Torna a provar la connexió:<br><code>psql -U hibuser -d hibernatedb</code></li>
    </ol>

    {% include warning_box.html contingut="Utilitza contrasenyes reals i segures en entorns de producció. En aquest tutorial s'utilitza 'password' només per facilitar la pràctica." %}

    <h3>Creació de l'usuari i base de dades</h3>
    <p>Executa les ordres següents des de <code>psql</code> amb l'usuari administrador <code>postgres</code>.</p>

    {% capture code_psql %}
-- Connecta com a superusuari
psql -U postgres

-- Usuari dedicat al projecte
CREATE USER hibuser WITH PASSWORD 'password';

-- Base de dades principal
CREATE DATABASE hibernatedb OWNER hibuser;

-- Atorga permisos addicionals (si cal)
GRANT ALL PRIVILEGES ON DATABASE hibernatedb TO hibuser;

-- Canvia a la nova base de dades
\c hibernatedb

-- Concedeix permisos sobre l'esquema
GRANT ALL ON SCHEMA public TO hibuser;
    {% endcapture %}
    {% include code-block.html lang="sql" code=code_psql %}

    <p>Verifica que l'usuari es pot connectar:</p>

    {% capture code_psql_check %}
psql -h localhost -U hibuser -d hibernatedb -W
    {% endcapture %}
    {% include code-block.html lang="bash" code=code_psql_check %}

    {% include success_box.html contingut="Si veus el prompt <code>hibernatedb=></code>, la configuració de PostgreSQL està llesta." %}

    {% include prompt-ai.html contingut="Necessito scripts SQL per inserir dades de prova a la taula productes (nom, preu, stock) un cop creada la base de dades hibernatedb. Escriu-los per PostgreSQL." %}
</div>

<div class="section">
    <h2 id="Unitat8_Bloc2_Seccio3">Configuració de Visual Studio Code i extensions</h2>

    <h3>Instal·lació de Visual Studio Code</h3>
    <ol>
        <li>Descarrega l'instal·lador corresponent a <a href="https://code.visualstudio.com/" target="_blank" rel="noopener">code.visualstudio.com</a>.</li>
        <li>Instal·la'l amb permisos d'administrador (Windows) o mou l'app a <code>/Applications</code> (macOS).</li>
        <li>Obre VS Code i inicia la sessió amb el teu compte per sincronitzar configuracions (opcional).</li>
    </ol>

    <h3>Extensions imprescindibles</h3>
    <ul>
        <li><strong>Extension Pack for Java</strong> (inclou Language Support, Debugger, Test Runner, Maven for Java).</li>
        <li><strong>Project Manager for Java</strong> (facilita la creació de projectes).</li>
        <li><strong>Database Client</strong> (o una extensió similar) per consultar PostgreSQL des del mateix editor.</li>
    </ul>

    {% include info_box.html contingut="Després d'instal·lar l'Extension Pack for Java, VS Code demanarà descarregar els components necessaris. Accepta totes les descàrregues." %}

    <h3>Configurar Maven i el JDK a VS Code</h3>
    <ol>
        <li>Obre la paleta de comandes (<code>Ctrl/Cmd + Shift + P</code>) i cerca <em>Preferences: Open Settings (JSON)</em>.</li>
        <li>Afegeix (o adapta) la configuració següent:</li>
    </ol>

    {% capture code_settings %}
{
    "java.configuration.runtimes": [
        {
            "name": "JavaSE-21",
            "path": "/ruta/al/jdk-21"
        }
    ],
    "maven.executable.path": "/ruta/al/mvn"
}
    {% endcapture %}
    {% include code-block.html lang="json" code=code_settings %}

    {% include prompt-ai.html contingut="Quines opcions de configuració recomanes a VS Code per millorar el rendiment del Java Language Server en projectes Maven grans? Dona'm fragments per afegir a settings.json." %}

    <h3>Connexió a la base de dades des de VS Code</h3>
    <p>Si instal·les un visor de bases de dades, afegeix una connexió nova amb els paràmetres:</p>
    <ul>
        <li><strong>Host:</strong> <code>localhost</code></li>
        <li><strong>Port:</strong> <code>5432</code></li>
        <li><strong>Database:</strong> <code>hibernatedb</code></li>
        <li><strong>User:</strong> <code>hibuser</code></li>
        <li><strong>Password:</strong> <code>password</code></li>
    </ul>

    {% include success_box.html contingut="Amb VS Code preparat tens un únic entorn per escriure codi, executar Maven, consultar PostgreSQL i depurar." %}
</div>

<div class="section">
    <h2 id="Unitat8_Bloc2_Seccio4">Creació del projecte Maven</h2>

    <p>El tutorial construeix un projecte anomenat <code>hibernate-demo</code> amb paquet base <code>cat.exemple</code>. Crea'l directament des de VS Code o via terminal.</p>

    <h3>Generar l'estructura</h3>
    <ol>
        <li>Obre VS Code i prem <strong>Ctrl/Cmd + Shift + P</strong>.</li>
        <li>Escriu <em>Maven: Create Maven Project</em> i selecciona <em>maven-archetype-quickstart</em>.</li>
        <li>Escull la versió més recent (1.4 a data del tutorial).</li>
        <li>Introdueix <strong>cat.exemple</strong> com a <em>Group Id</em>.</li>
        <li>Introdueix <strong>hibernate-demo</strong> com a <em>Artifact Id</em>.</li>
        <li>Mantenim la versió <code>1.0-SNAPSHOT</code> (o la que prefereixis).</li>
        <li>Selecciona el directori on vols crear el projecte i espera a que Maven generi l'esquelet.</li>
    </ol>

    <h3>Verificació de l'estructura</h3>
    <p>A l'explorador hauries de veure:</p>

    {% capture code_tree %}
hibernate-demo/
├── pom.xml
├── src
│   ├── main
│   │   └── java
│   │       └── cat
│   │           └── exemple
│   │               └── App.java
│   └── test
│       └── java
│           └── cat
│               └── exemple
│                   └── AppTest.java
└── README.md
    {% endcapture %}
    {% include code-block.html lang="text" code=code_tree %}

    <p>Substituirem la classe <code>App</code> per <code>Application</code> més endavant. De moment, deixa els fitxers generats.</p>

    {% include info_box.html contingut="Si Maven no apareix a la barra lateral, obre la paleta de comandes i executa 'Maven: Reload project'." %}

    {% include prompt-ai.html contingut="Crea un script bash que generi l'estructura del projecte hibernate-demo i col·loqui esquelets buits per a HibernateUtil, Producte, ProducteDAO i Application." %}
</div>

<div class="section">
    <h2 id="Unitat8_Bloc2_Seccio5">Configuració de Hibernate</h2>

    <h3>Actualitzar <code>pom.xml</code></h3>
    <p>Obre el fitxer <code>pom.xml</code> i substitueix el contingut pel fragment del tutorial:</p>

    {% capture code_pom %}
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>cat.exemple</groupId>
    <artifactId>hibernate-demo</artifactId>
    <version>1.0-SNAPSHOT</version>

    <properties>
        <maven.compiler.source>21</maven.compiler.source>
        <maven.compiler.target>21</maven.compiler.target>
        <project.build.sourceEncoding>UTF8</project.build.sourceEncoding>
        <hibernate.version>6.4.4.Final</hibernate.version>
        <postgresql.version>42.7.2</postgresql.version>
    </properties>

    <dependencies>
        <!-- Hibernate Core -->
        <dependency>
            <groupId>org.hibernate.orm</groupId>
            <artifactId>hibernate-core</artifactId>
            <version>${hibernate.version}</version>
        </dependency>

        <!-- Driver JDBC de PostgreSQL -->
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <version>${postgresql.version}</version>
        </dependency>

        <!-- Jakarta Persistence API -->
        <dependency>
            <groupId>jakarta.persistence</groupId>
            <artifactId>jakarta.persistence-api</artifactId>
            <version>3.1.0</version>
        </dependency>

        <!-- Logging -->
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>2.0.9</version>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-simple</artifactId>
            <version>2.0.9</version>
        </dependency>

        <!-- JUnit per als tests -->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.13.2</version>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>${maven.compiler.source}</source>
                    <target>${maven.compiler.target}</target>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>exec-maven-plugin</artifactId>
                <version>3.1.0</version>
                <configuration>
                    <mainClass>cat.exemple.Application</mainClass>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
    {% endcapture %}
    {% include code-block.html lang="xml" code=code_pom %}

    <ol>
        <li>Desa el fitxer i accepta l'alerta «Maven project configuration updated».</li>
        <li>Si no apareix, executa manualment <em>Maven: Update project</em>.</li>
        <li>Espera a que Maven descarregui totes les dependències (observa la barra d'estat).</li>
    </ol>

    {% include warning_box.html contingut="Aquest conjunt de versions està testat amb el tutorial. Canviar versions pot introduir incompatibilitats amb Java 21." %}

    <h3>Crear <code>hibernate.cfg.xml</code></h3>
    <ol>
        <li>Crea la carpeta <code>src/main/resources</code> si no existeix.</li>
        <li>Afegeix el fitxer <code>hibernate.cfg.xml</code> amb el contingut següent:</li>
    </ol>

    {% capture code_hibernate_cfg %}
<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE hibernate-configuration PUBLIC
        "http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd">
<hibernate-configuration>
    <session-factory>
        <property name="hibernate.connection.driver_class">org.postgresql.Driver</property>
        <property name="hibernate.connection.url">jdbc:postgresql://localhost:5432/hibernatedb</property>
        <property name="hibernate.connection.username">hibuser</property>
        <property name="hibernate.connection.password">password</property>
        <property name="hibernate.dialect">org.hibernate.dialect.PostgreSQLDialect</property>
        <property name="hibernate.hbm2ddl.auto">update</property>
        <property name="hibernate.show_sql">true</property>
        <property name="hibernate.format_sql">true</property>
        <property name="hibernate.current_session_context_class">thread</property>
        <property name="hibernate.mapping.precedence">class,hbm</property>

        <mapping class="cat.exemple.model.Producte" />
    </session-factory>
</hibernate-configuration>
    {% endcapture %}
    {% include code-block.html lang="xml" code=code_hibernate_cfg %}

    {% include info_box.html contingut="L'opció <code>hibernate.hbm2ddl.auto=update</code> crea o modifica les taules a cada arrencada. En entorns productius utilitza eines de migració." %}

    {% include prompt-ai.html contingut="Transforma el fitxer hibernate.cfg.xml perquè utilitzi propietats o variables d'entorn quan desplegui a un servidor remots. Dona'm un exemple complet." %}
</div>

<div class="section">
    <h2 id="Unitat8_Bloc2_Seccio6">Implementació de les classes Java</h2>

    <p>Aquesta secció replica els passos exactes del tutorial per construir les classes <code>HibernateUtil</code>, <code>Producte</code>, <code>ProducteDAO</code> i <code>Application</code>. Segueix l'ordre indicat per evitar errors de dependència.</p>

    <h3>Organització de paquets</h3>
    <p>Crea els paquets següents dins de <code>src/main/java</code>:</p>
    <ul>
        <li><code>cat.exemple.util</code></li>
        <li><code>cat.exemple.model</code></li>
        <li><code>cat.exemple.dao</code></li>
    </ul>

    <h3>Classe <code>HibernateUtil</code></h3>

    {% capture code_hibernate_util %}
package cat.exemple.util;

import org.hibernate.SessionFactory;
import org.hibernate.boot.registry.StandardServiceRegistryBuilder;
import org.hibernate.cfg.Configuration;
import org.hibernate.service.ServiceRegistry;

import cat.exemple.model.Producte;

public class HibernateUtil {
    private static final SessionFactory sessionFactory;

    static {
        try {
            Configuration configuration = new Configuration();
            configuration.configure("hibernate.cfg.xml");
            configuration.addAnnotatedClass(Producte.class);

            ServiceRegistry serviceRegistry = new StandardServiceRegistryBuilder()
                .applySettings(configuration.getProperties())
                .build();

            sessionFactory = configuration.buildSessionFactory(serviceRegistry);
            System.out.println("Hibernate SessionFactory inicialitzat amb èxit");
        } catch (Throwable ex) {
            System.err.println("Error en la inicialització de SessionFactory: " + ex);
            ex.printStackTrace();
            throw new ExceptionInInitializerError(ex);
        }
    }

    public static SessionFactory getSessionFactory() {
        return sessionFactory;
    }

    public static void shutdown() {
        if (sessionFactory != null && !sessionFactory.isClosed()) {
            sessionFactory.close();
            System.out.println("SessionFactory tancat");
        }
    }
}
    {% endcapture %}
    {% include code-block.html lang="java" code=code_hibernate_util %}

    {% include prompt-ai.html contingut="Com puc registrar automàticament totes les classes del paquet cat.exemple.model a Hibernate sense cridar addAnnotatedClass per cadascuna? Dona'm opcions." %}

    <h3>Classe model <code>Producte</code></h3>

    {% capture code_producte %}
package cat.exemple.model;

import jakarta.persistence.*;
import java.math.BigDecimal;

@Entity
@Table(name = "productes")
public class Producte {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "nom", nullable = false, length = 100)
    private String nom;

    @Column(name = "preu", precision = 10, scale = 2)
    private BigDecimal preu;

    @Column(name = "stock")
    private Integer stock;

    public Producte() {
    }

    public Producte(String nom, BigDecimal preu, Integer stock) {
        this.nom = nom;
        this.preu = preu;
        this.stock = stock;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getNom() {
        return nom;
    }

    public void setNom(String nom) {
        this.nom = nom;
    }

    public BigDecimal getPreu() {
        return preu;
    }

    public void setPreu(BigDecimal preu) {
        this.preu = preu;
    }

    public Integer getStock() {
        return stock;
    }

    public void setStock(Integer stock) {
        this.stock = stock;
    }

    @Override
    public String toString() {
        return "Producte [id=" + id + ", nom=" + nom + ", preu=" + preu + ", stock=" + stock + "]";
    }
}
    {% endcapture %}
    {% include code-block.html lang="java" code=code_producte %}

    {% include info_box.html contingut="El model utilitza anotacions de Jakarta Persistence (JPA 3). Això assegura compatibilitat amb Hibernate 6." %}

    <h3>Classe DAO <code>ProducteDAO</code></h3>

    {% capture code_producte_dao %}
package cat.exemple.dao;

import java.util.List;

import org.hibernate.Session;
import org.hibernate.Transaction;
import org.hibernate.query.Query;

import cat.exemple.model.Producte;
import cat.exemple.util.HibernateUtil;

public class ProducteDAO {

    /**
     * Desa un producte a la base de dades i retorna l'identificador generat.
     */
    public Long save(Producte producte) {
        Transaction transaction = null;
        try (Session session = HibernateUtil.getSessionFactory().openSession()) {
            transaction = session.beginTransaction();
            Long id = (Long) session.save(producte);
            transaction.commit();
            return id;
        } catch (Exception e) {
            if (transaction != null) {
                transaction.rollback();
            }
            e.printStackTrace();
            throw e;
        }
    }

    /**
     * Obté un producte pel seu identificador.
     */
    public Producte getById(Long id) {
        try (Session session = HibernateUtil.getSessionFactory().openSession()) {
            return session.get(Producte.class, id);
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    /**
     * Retorna tots els productes.
     */
    public List<Producte> getAll() {
        try (Session session = HibernateUtil.getSessionFactory().openSession()) {
            Query<Producte> query = session.createQuery("from Producte", Producte.class);
            return query.list();
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    /**
     * Actualitza un producte existent.
     */
    public void update(Producte producte) {
        Transaction transaction = null;
        try (Session session = HibernateUtil.getSessionFactory().openSession()) {
            transaction = session.beginTransaction();
            session.update(producte);
            transaction.commit();
        } catch (Exception e) {
            if (transaction != null) {
                transaction.rollback();
            }
            e.printStackTrace();
            throw e;
        }
    }

    /**
     * Elimina un producte.
     */
    public void delete(Producte producte) {
        Transaction transaction = null;
        try (Session session = HibernateUtil.getSessionFactory().openSession()) {
            transaction = session.beginTransaction();
            session.delete(producte);
            transaction.commit();
        } catch (Exception e) {
            if (transaction != null) {
                transaction.rollback();
            }
            e.printStackTrace();
            throw e;
        }
    }

    /**
     * Cerca productes pel nom.
     */
    public List<Producte> findByName(String nom) {
        try (Session session = HibernateUtil.getSessionFactory().openSession()) {
            Query<Producte> query = session.createQuery("from Producte where nom like :nom", Producte.class);
            query.setParameter("nom", "%" + nom + "%");
            return query.list();
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }
}
    {% endcapture %}
    {% include code-block.html lang="java" code=code_producte_dao %}

    {% include warning_box.html contingut="Hibernate 6 introdueix nous mètodes (persist/merge/remove). El tutorial manté save/update/delete per simplicitat, però tingues-ho present per a projectes avançats." %}

    <h3>Classe principal <code>Application</code></h3>

    {% capture code_application %}
package cat.exemple;

import java.math.BigDecimal;
import java.util.List;

import cat.exemple.dao.ProducteDAO;
import cat.exemple.model.Producte;
import cat.exemple.util.HibernateUtil;

public class Application {
    private static final ProducteDAO producteDAO = new ProducteDAO();

    public static void main(String[] args) {
        try {
            System.out.println("Iniciant aplicació Hibernate amb PostgreSQL...");

            crearProductes();
            mostrarTotsElsProductes();
            actualitzarProducte();
            cercarProductesPerNom("por");
            eliminarProducte();
            mostrarTotsElsProductes();

            System.out.println("Fi de l'aplicació");
        } catch (Exception e) {
            System.err.println("Error en l'aplicació: " + e.getMessage());
            e.printStackTrace();
        } finally {
            HibernateUtil.shutdown();
        }
    }

    private static void crearProductes() {
        System.out.println("\n=== Creant productes ===");
        Producte p1 = new Producte("Portàtil XPS", new BigDecimal("1299.99"), 10);
        Producte p2 = new Producte("Teclat Mecànic", new BigDecimal("89.99"), 25);
        Producte p3 = new Producte("Ratolí Gaming", new BigDecimal("49.99"), 30);

        producteDAO.save(p1);
        producteDAO.save(p2);
        producteDAO.save(p3);
        System.out.println("Productes creats amb èxit");
    }

    private static void mostrarTotsElsProductes() {
        System.out.println("\n=== Tots els productes ===");
        List<Producte> productes = producteDAO.getAll();
        if (productes.isEmpty()) {
            System.out.println("No hi ha productes a la base de dades.");
        } else {
            for (Producte p : productes) {
                System.out.println(p);
            }
        }
    }

    private static void actualitzarProducte() {
        System.out.println("\n=== Actualitzant producte ===");
        List<Producte> productes = producteDAO.getAll();
        if (!productes.isEmpty()) {
            Producte producte = productes.get(0);
            System.out.println("Producte abans d'actualitzar: " + producte);

            producte.setPreu(new BigDecimal("1199.99"));
            producte.setStock(producte.getStock() - 2);
            producteDAO.update(producte);

            producte = producteDAO.getById(producte.getId());
            System.out.println("Producte després d'actualitzar: " + producte);
        } else {
            System.out.println("No hi ha productes per actualitzar.");
        }
    }

    private static void cercarProductesPerNom(String nom) {
        System.out.println("\n=== Cercant productes amb nom que contingui '" + nom + "' ===");
        List<Producte> productes = producteDAO.findByName(nom);
        if (productes.isEmpty()) {
            System.out.println("Cap producte trobat amb el nom '" + nom + "'");
        } else {
            for (Producte p : productes) {
                System.out.println(p);
            }
        }
    }

    private static void eliminarProducte() {
        System.out.println("\n=== Eliminant producte ===");
        List<Producte> productes = producteDAO.getAll();
        if (!productes.isEmpty()) {
            Producte producteAEliminar = productes.get(productes.size() - 1);
            System.out.println("Eliminant: " + producteAEliminar);
            producteDAO.delete(producteAEliminar);
            System.out.println("Producte eliminat");
        } else {
            System.out.println("No hi ha productes per eliminar.");
        }
    }
}
    {% endcapture %}
    {% include code-block.html lang="java" code=code_application %}

    <h3>Fitxer de test <code>AppTest</code></h3>
    <ol>
        <li>Obre <code>src/test/java/cat/exemple/AppTest.java</code>.</li>
        <li>Confirma que conté:</li>
    </ol>

    {% capture code_apptest %}
package cat.exemple;

import static org.junit.Assert.assertTrue;

import org.junit.Test;

public class AppTest {
    @Test
    public void shouldAnswerWithTrue() {
        assertTrue(true);
    }
}
    {% endcapture %}
    {% include code-block.html lang="java" code=code_apptest %}

    {% include prompt-ai.html contingut="Vull afegir tests unitats per ProducteDAO utilitzant una base de dades en memòria (H2). Especifica quines dependències i configuracions haig d'afegir i entrega'm un exemple de test." %}
</div>

<div class="section">
    <h2 id="Unitat8_Bloc2_Seccio7">Compilació, proves i execució final</h2>

    <h3>Compilació i execució de Maven</h3>
    <ol>
        <li>Obre la barra lateral de Maven a VS Code.</li>
        <li>Executa <code>clean</code> i després <code>compile</code> (clic dret → <em>Run</em>).</li>
        <li>Comprova la consola: ha d'aparèixer <strong>BUILD SUCCESS</strong>.</li>
    </ol>

    {% capture code_maven_clean_compile %}
mvn clean
mvn compile
    {% endcapture %}
    {% include code-block.html lang="bash" code=code_maven_clean_compile %}

    <h3>Execució dels tests JUnit</h3>
    <ol>
        <li>Al menú Maven → Lifecycle, executa <code>test</code>.</li>
        <li>Alternativament, obre <code>AppTest.java</code> i fes clic a <em>Run Test</em>.</li>
        <li>Confirma que els tests acaben amb <strong>BUILD SUCCESS</strong>.</li>
    </ol>

    <h3>Execució de l'aplicació</h3>
    <ol>
        <li>Assegura't que el servei PostgreSQL està actiu.</li>
        <li>Executa el plugin <code>exec:java</code> (Plugins → exec → exec:java → Run).</li>
        <li>O bé, obre <code>Application.java</code> i fes clic al botó <em>Run</em>.</li>
        <li>Observa els logs d'Hibernate: es mostraran les consultes SQL generades.</li>
    </ol>

    {% capture code_maven_exec %}
mvn exec:java -Dexec.mainClass="cat.exemple.Application"
    {% endcapture %}
    {% include code-block.html lang="bash" code=code_maven_exec %}

    <h3>Verificació a PostgreSQL</h3>
    <ol>
        <li>Connecta't: <code>psql -U hibuser -d hibernatedb</code>.</li>
        <li>Llista les taules amb <code>\dt</code>.</li>
        <li>Consulta el contingut: <code>SELECT * FROM productes;</code></li>
        <li>Confirma que els registres coincideixen amb els mostrats per l'aplicació (incloent l'actualització i l'eliminació).</li>
    </ol>

    {% capture code_psql_verify %}
psql -h localhost -U hibuser -d hibernatedb -W
\dt
SELECT * FROM productes;
\q
    {% endcapture %}
    {% include code-block.html lang="sql" code=code_psql_verify %}

    <h3>Visor de bases de dades a VS Code</h3>
    <ol>
        <li>Obre l'extensió de Base de Dades instal·lada.</li>
        <li>Crea una connexió nova amb les credencials del tutorial.</li>
        <li>Explora la taula <code>productes</code> i actualitza-la després d'executar l'aplicació per veure els canvis en temps real.</li>
    </ol>

    <h3>Solució de problemes comuns</h3>
    {% include checklist.html titol="Diagnòstic ràpid" elements="PostgreSQL en execució (servei actiu)|Credencials correctes a hibernate.cfg.xml|Autenticació Linux configurada a md5|Dependències Maven descarregades sense errors" %}

    <h4>Problemes de connexió</h4>
    <ul>
        <li>Comprova <code>hibernate.cfg.xml</code> (URL, usuari, contrasenya).</li>
        <li>Intenta connectar-te manualment amb <code>psql</code>.</li>
        <li>En Windows, assegura't que el directori <code>PostgreSQL\bin</code> és al PATH.</li>
    </ul>

    <h4>Errors d'autenticació en Linux</h4>
    <ul>
        <li>Revisa <code>pg_hba.conf</code> i canvia a <code>md5</code>.</li>
        <li>Reinicia el servei: <code>sudo systemctl restart postgresql</code>.</li>
    </ul>

    <h4>Problemes amb Maven o VS Code</h4>
    <ul>
        <li>Executa <em>Maven: Clean</em> i <em>Maven: Update project</em>.</li>
        <li>Si hi ha errors d'import, comprova que el <code>pom.xml</code> està guardat i sense conflictes.</li>
    </ul>
    <h4>Problemes amb els tests</h4>
    <ul>
        <li>Confirma que la dependència de JUnit (4.13.2) és present al <code>pom.xml</code>.</li>
        <li>Actualitza el projecte Maven després d'afegir la dependència.</li>
        <li>Verifica que el paquet del test sigui <code>cat.exemple</code> i que la classe <code>AppTest</code> importi les classes correctes.</li>
        <li>Executa els tests des de la línia d'ordres amb <code>mvn test</code> per veure el traç complet.</li>
    </ul>

    <h4>Problemes amb Hibernate</h4>
    <ul>
        <li>Activa <code>&lt;property name="hibernate.use_sql_comments"&gt;true&lt;/property&gt;</code> per obtenir logs més descriptius.</li>
        <li>Revisa que totes les classes anotades estan registrades a <code>HibernateUtil</code> i al fitxer de configuració.</li>
        <li>Si hi ha conflictes d'esquema, canvia temporalment <code>hibernate.hbm2ddl.auto</code> a <code>create</code> i torna a <code>update</code> un cop resolt.</li>
        <li>Buida la base de dades o ajusta les dades d'entrada quan es produeixin errors de restriccions (per exemple, columnes úniques).</li>
    </ul>

    <h3>Activitat d'ampliació</h3>
    {% include exercici.html
       nom="Afegeix l'entitat Categoria"
       dificultat="Mitjana"
       temps="25 min"
       descripcio="<p>Crea la classe <code>Categoria</code> amb relació <em>One-to-Many</em> a <code>Producte</code>. Actualitza <code>Producte</code>, registra la classe a Hibernate i estèn <code>Application</code> perquè mostri la categoria a cada producte.</p>"
       pistes="Declara @OneToMany i @ManyToOne amb les anotacions corresponents|Afegeix la nova entitat a HibernateUtil i al fitxer hibernate.cfg.xml|Crea un mètode al DAO per llistar productes agrupats per categoria"
    %}

    {% capture solucio_categoria_text %}
<ul>
    <li>Defineix <code>Categoria</code> amb <code>@OneToMany(mappedBy="categoria")</code> i registra-la a Hibernate.</li>
    <li>Actualitza <code>Producte</code> per afegir <code>@ManyToOne</code> i la columna <code>categoria_id</code>.</li>
    <li>Ajusta <code>HibernateUtil</code> i <code>hibernate.cfg.xml</code> per incloure la nova entitat.</li>
    <li>Extén <code>Application</code> per crear categories i associar-les als productes abans de llistar-los.</li>
</ul>
    {% endcapture %}
    {% capture solucio_categoria_code %}
// src/main/java/cat/exemple/model/Categoria.java
package cat.exemple.model;

import jakarta.persistence.*;
import java.util.ArrayList;
import java.util.List;

@Entity
@Table(name = "categories")
public class Categoria {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, length = 80, unique = true)
    private String nom;

    @OneToMany(mappedBy = "categoria", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Producte> productes = new ArrayList<>();

    public Categoria() {}

    public Categoria(String nom) {
        this.nom = nom;
    }

    public Long getId() {
        return id;
    }

    public String getNom() {
        return nom;
    }

    public void setNom(String nom) {
        this.nom = nom;
    }

    public List<Producte> getProductes() {
        return productes;
    }
}

// Afegir al fitxer Producte.java
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "categoria_id")
private Categoria categoria;

public Categoria getCategoria() {
    return categoria;
}

public void setCategoria(Categoria categoria) {
    this.categoria = categoria;
}

// HibernateUtil.java
configuration.addAnnotatedClass(Categoria.class);

// hibernate.cfg.xml
<mapping class="cat.exemple.model.Categoria" />

// Application.java (fragment)
Categoria tecnologia = new Categoria("Tecnologia");
Categoria periferiques = new Categoria("Perifèrics");

Producte p1 = new Producte("Portàtil XPS", new BigDecimal("1299.99"), 10);
p1.setCategoria(tecnologia);
Producte p2 = new Producte("Teclat Mecànic", new BigDecimal("89.99"), 25);
p2.setCategoria(periferiques);

producteDAO.save(p1);
producteDAO.save(p2);
    {% endcapture %}
    <details class="solution-toggle">
        <summary>Mostra la solució orientativa</summary>
        {% include solucio.html contingut=solucio_categoria_text %}
        {% include code-block.html lang="java" code=solucio_categoria_code %}
    </details>

    <h4>Utilització de consultes més complexes</h4>
    <ul>
        <li>Afegeix mètodes a <code>ProducteDAO</code> utilitzant la Criteria API o consultes HQL amb <code>ORDER BY</code>, filtres i agregacions.</li>
        <li>Experimenta amb <code>JOIN FETCH</code> per carregar categories i productes en una sola consulta.</li>
        <li>Analitza el rendiment activant <code>show_sql</code> i els comentaris SQL.</li>
    </ul>

    <h4>Afegir una interfície d'usuari</h4>
    <ul>
        <li>Afegeix dependències de JavaFX o Swing al <code>pom.xml</code> per construir una UI d'escriptori.</li>
        <li>Crea pantalles per llistar productes, afegir-ne de nous i actualitzar-ne el preu.</li>
        <li>Centralitza la lògica a la capa de servei per mantenir la UI desacoblada.</li>
    </ul>

    <h3>Resum final</h3>
    <p>Has completat un projecte funcional amb Hibernate 6, PostgreSQL i Maven:</p>
    <ul>
        <li>Instal·lació i configuració de totes les eines necessàries.</li>
        <li>Creació d'un projecte Maven estructurat.</li>
        <li>Configuració d'Hibernate i implementació de la capa de persistència.</li>
        <li>Execució de CRUD complet i verificació directament a PostgreSQL.</li>
        <li>Diagnòstic dels errors més habituals i suggeriments d'ampliació.</li>
    </ul>

    {% include prompt-ai.html contingut="Proposa nous casos d'ús (per exemple comandes i factures) i descriu quines entitats, DAOs i relacions hauria d'afegir per suportar-los amb Hibernate 6." %}

    <h3>Referències i recursos</h3>
    <ul>
        <li><a href="https://hibernate.org/orm/documentation/" target="_blank" rel="noopener">Documentació oficial d'Hibernate ORM</a></li>
        <li><a href="https://www.postgresql.org/docs/" target="_blank" rel="noopener">Manual oficial de PostgreSQL</a></li>
        <li><a href="https://code.visualstudio.com/docs/java/java-tutorial" target="_blank" rel="noopener">Guia de Java a Visual Studio Code</a></li>
    </ul>

    {% include success_box.html contingut="Amb el tutorial completat tens una base sòlida per abordar RA8 i RA9 i construir aplicacions empresarials amb Hibernate." %}
</div>
